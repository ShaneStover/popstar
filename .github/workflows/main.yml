    - name: Setup VC environment and build with MSBuild
      shell: pwsh
      run: |
        $msbuild = "${{ steps.findvs.outputs.msbuild }}"
        $inst = "${{ steps.findvs.outputs.instpath }}"
        Write-Host "Using MSBuild: $msbuild"
        $vcvars = Join-Path $inst "VC\Auxiliary\Build\vcvarsall.bat"
        if (-not (Test-Path $vcvars)) {
          Write-Error "vcvarsall.bat not found at $vcvars"
          exit 1
        }

        $sln = "src\popstar-external.sln"
        $msbuildArgs = "/p:Configuration=Release /p:Platform=x64"

        # Build a .bat that calls vcvarsall and msbuild in the same cmd session
        $batContent = @"
@echo off
call "$vcvars" x64
"$msbuild" "$sln" $msbuildArgs
exit /b %ERRORLEVEL%
"@

        Set-Content -Path build-and-run.bat -Value $batContent -Encoding ASCII

        Write-Host "Contents of build-and-run.bat:"
        Get-Content build-and-run.bat | ForEach-Object { Write-Host $_ }

        # Execute the batch file and propagate exit code
        & cmd.exe /c .\build-and-run.bat
        if ($LASTEXITCODE -ne 0) { exit $LASTEXITCODE }
